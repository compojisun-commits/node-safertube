rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // analysisRequests 컬렉션
    match /analysisRequests/{docId} {
      // 누구나 생성 가능 (익명 사용자도 분석 요청 가능)
      allow create: if true;

      // 생성한 요청은 읽기 가능
      allow read: if true;

      // 업데이트: 이메일 알림 설정(sendEmail, userEmail)만 허용
      allow update: if request.resource.data.diff(resource.data).affectedKeys().hasOnly(['sendEmail', 'userEmail']);

      // 삭제 불가
      allow delete: if false;
    }

    // recommendationRequests 컬렉션 (영상 추천)
    match /recommendationRequests/{docId} {
      // 누구나 생성 가능
      allow create: if true;

      // 생성한 요청은 읽기 가능
      allow read: if true;

      // 업데이트: 이메일 알림 설정(sendEmail, userEmail)만 허용
      allow update: if request.resource.data.diff(resource.data).affectedKeys().hasOnly(['sendEmail', 'userEmail']);

      // 삭제 불가
      allow delete: if false;
    }

    // users 컬렉션 (크레딧 관리)
    match /users/{userId} {
      // 자신의 문서만 읽기 가능
      allow read: if request.auth != null && request.auth.uid == userId;

      // Cloud Functions와 자신만 쓰기 가능
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // anonymousUsage 컬렉션 (비로그인 사용자 크레딧 관리)
    match /anonymousUsage/{anonymousId} {
      // Cloud Functions만 읽기/쓰기 가능
      allow read, write: if false;
    }

    // anonymousRecommendUsage 컬렉션 (비로그인 사용자 추천 크레딧 관리)
    match /anonymousRecommendUsage/{anonymousId} {
      // Cloud Functions만 읽기/쓰기 가능
      allow read, write: if false;
    }

    // jjimVideos 컬렉션 (찜 보따리)
    // 새 구조: 문서 ID가 userUid 또는 userUid_숫자 형태
    match /jjimVideos/{docId} {
      // 문서 ID가 자신의 UID로 시작하는 경우에만 읽기/쓰기 가능
      // 예: "user123" 또는 "user123_1", "user123_2" 등
      allow read, write: if request.auth != null &&
                            (docId == request.auth.uid ||
                             docId.matches('^' + request.auth.uid + '_[0-9]+$'));
    }

    // sharedVideos 컬렉션 (풀어 보따리)
    match /sharedVideos/{docId} {
      // 로그인한 사용자만 생성 가능
      allow create: if request.auth != null && request.resource.data.authorId == request.auth.uid;

      // 모두 읽기 가능
      allow read: if true;

      // 자신이 공유한 영상만 수정/삭제 가능
      allow update, delete: if request.auth != null && resource.data.authorId == request.auth.uid;
    }
  }
}
