import { useState, useEffect } from 'react';
import { doc, setDoc, getDoc, Timestamp } from 'firebase/firestore';
import { db } from '../firebase/config';
import { useAuth } from '../context/AuthContext';
import { generateUserFolders } from '../utils/folderGenerator';
import Swal from 'sweetalert2';
import '../styles/onboarding.css';

const SUBJECTS = [
  { id: 'kor', name: 'êµ­ì–´', color: '#ef4444' },
  { id: 'math', name: 'ìˆ˜í•™', color: '#3b82f6' },
  { id: 'soc', name: 'ì‚¬íšŒ', color: '#f59e0b' },
  { id: 'sci', name: 'ê³¼í•™', color: '#10b981' },
  { id: 'moral', name: 'ë„ë•', color: '#8b5cf6' },
  { id: 'prac', name: 'ì‹¤ê³¼', color: '#06b6d4' },
  { id: 'music', name: 'ìŒì•…', color: '#ec4899' },
  { id: 'art', name: 'ë¯¸ìˆ ', color: '#f97316' },
  { id: 'pe', name: 'ì²´ìœ¡', color: '#22c55e' },
  { id: 'eng', name: 'ì˜ì–´', color: '#6366f1' },
];

const GRADES = [1, 2, 3, 4, 5, 6];

// ì•„ì´ì½˜ ì»´í¬ë„ŒíŠ¸
const IconX = () => (
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
  </svg>
);

// í´ë” ê³„ì¸µ êµ¬ì¡° ì˜µì…˜
const FOLDER_HIERARCHY_OPTIONS = [
  { 
    id: 'grade-semester-subject', 
    name: 'í•™ë…„ > í•™ê¸° > ê³¼ëª©', 
    example: '6í•™ë…„ > 1í•™ê¸° > êµ­ì–´ > ë‹¨ì›',
    icon: 'ğŸ“š'
  },
  { 
    id: 'grade-subject-semester', 
    name: 'í•™ë…„ > ê³¼ëª© > í•™ê¸°', 
    example: '6í•™ë…„ > êµ­ì–´ > 1í•™ê¸° > ë‹¨ì›',
    icon: 'ğŸ“–'
  },
  { 
    id: 'grade-subject', 
    name: 'í•™ë…„ > ê³¼ëª© (í•™ê¸° ì—†ìŒ)', 
    example: '6í•™ë…„ > êµ­ì–´ > ë‹¨ì›',
    icon: 'ğŸ“'
  },
];

export default function SettingsModal({ onClose }) {
  const { user } = useAuth();
  const [loading, setLoading] = useState(true);
  const [role, setRole] = useState('homeroom');
  const [grade, setGrade] = useState(null);
  const [targetGrades, setTargetGrades] = useState([]);
  const [targetSubjects, setTargetSubjects] = useState([]);
  const [folderHierarchy, setFolderHierarchy] = useState('grade-semester-subject');
  const [isSubmitting, setIsSubmitting] = useState(false);
  
  // ì´ˆê¸° ì„¤ì •ê°’ ì €ì¥ (ë³€ê²½ ê°ì§€ìš©)
  const [initialSettings, setInitialSettings] = useState(null);

  // ê¸°ì¡´ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
  useEffect(() => {
    const loadSettings = async () => {
      if (!user) return;
      
      try {
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        if (userDoc.exists()) {
          const data = userDoc.data();
          const loadedRole = data.role || 'homeroom';
          const loadedGrade = data.grade || null;
          const loadedTargetGrades = data.target_grades || [];
          const loadedTargetSubjects = data.target_subjects || SUBJECTS.map(s => s.id);
          const loadedFolderHierarchy = data.folder_hierarchy || 'grade-semester-subject';
          
          setRole(loadedRole);
          setGrade(loadedGrade);
          setTargetGrades(loadedTargetGrades);
          setTargetSubjects(loadedTargetSubjects);
          setFolderHierarchy(loadedFolderHierarchy);
          
          // ì´ˆê¸°ê°’ ì €ì¥
          setInitialSettings({
            role: loadedRole,
            grade: loadedGrade,
            targetGrades: loadedTargetGrades,
            targetSubjects: loadedTargetSubjects,
            folderHierarchy: loadedFolderHierarchy
          });
        } else {
          // ìƒˆ ì‚¬ìš©ìì˜ ê²½ìš° í˜„ì¬ ê¸°ë³¸ê°’ì„ ì´ˆê¸°ê°’ìœ¼ë¡œ ì €ì¥
          setInitialSettings({
            role: 'homeroom',
            grade: null,
            targetGrades: [],
            targetSubjects: SUBJECTS.map(s => s.id),
            folderHierarchy: 'grade-semester-subject'
          });
        }
      } catch (error) {
        console.error('ì„¤ì • ë¡œë“œ ì˜¤ë¥˜:', error);
      } finally {
        setLoading(false);
      }
    };
    
    loadSettings();
  }, [user]);

  // ì‹¤ì œ ë³€ê²½ ê°ì§€ í•¨ìˆ˜
  const hasChanges = () => {
    if (!initialSettings) return false;
    
    const gradesSame = JSON.stringify([...targetGrades].sort()) === 
                       JSON.stringify([...initialSettings.targetGrades].sort());
    const subjectsSame = JSON.stringify([...targetSubjects].sort()) === 
                         JSON.stringify([...initialSettings.targetSubjects].sort());
    
    return (
      role !== initialSettings.role ||
      grade !== initialSettings.grade ||
      !gradesSame ||
      !subjectsSame ||
      folderHierarchy !== initialSettings.folderHierarchy
    );
  };

  // ì—­í•  ë³€ê²½
  const handleRoleChange = (newRole) => {
    setRole(newRole);
    if (newRole === 'homeroom') {
      setTargetSubjects(SUBJECTS.map(s => s.id));
      setTargetGrades([]);
    } else {
      setTargetSubjects([]);
      setGrade(null);
    }
  };

  // í•™ë…„ í† ê¸€ (ì „ë‹´ìš©)
  const toggleGrade = (g) => {
    setTargetGrades(prev => 
      prev.includes(g) ? prev.filter(x => x !== g) : [...prev, g]
    );
  };

  // ê³¼ëª© í† ê¸€
  const toggleSubject = (subjectId) => {
    setTargetSubjects(prev =>
      prev.includes(subjectId) 
        ? prev.filter(x => x !== subjectId) 
        : [...prev, subjectId]
    );
  };

  // ì „ì²´ ì„ íƒ/í•´ì œ
  const toggleAllSubjects = () => {
    if (targetSubjects.length === SUBJECTS.length) {
      setTargetSubjects([]);
    } else {
      setTargetSubjects(SUBJECTS.map(s => s.id));
    }
  };

  // Swal ê³µí†µ ì˜µì…˜ (z-index ë¬¸ì œ í•´ê²°)
  const swalOptions = {
    customClass: {
      container: 'swal-above-modal'
    }
  };

  // ì €ì¥
  const handleSave = async () => {
    // ìœ íš¨ì„± ê²€ì‚¬
    if (role === 'homeroom' && !grade) {
      Swal.fire({
        ...swalOptions,
        icon: 'warning',
        title: 'í•™ë…„ì„ ì„ íƒí•´ì£¼ì„¸ìš”',
        confirmButtonColor: '#3b82f6'
      });
      return;
    }

    if (role === 'subject' && targetGrades.length === 0) {
      Swal.fire({
        ...swalOptions,
        icon: 'warning',
        title: 'ë‹´ë‹¹ í•™ë…„ì„ ì„ íƒí•´ì£¼ì„¸ìš”',
        confirmButtonColor: '#3b82f6'
      });
      return;
    }

    if (targetSubjects.length === 0) {
      Swal.fire({
        ...swalOptions,
        icon: 'warning',
        title: 'ë‹´ë‹¹ ê³¼ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”',
        confirmButtonColor: '#3b82f6'
      });
      return;
    }

    // ë³€ê²½ ì‚¬í•­ì´ ì—†ëŠ” ê²½ìš°
    if (!hasChanges()) {
      Swal.fire({
        ...swalOptions,
        icon: 'info',
        title: 'ë³€ê²½ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤',
        text: 'ì„¤ì •ì„ ë³€ê²½í•œ í›„ ì €ì¥í•´ì£¼ì„¸ìš”.',
        confirmButtonColor: '#6366f1',
        timer: 2000
      });
      return;
    }

    // í´ë” ì¬ìƒì„± í™•ì¸
    const confirmResult = await Swal.fire({
      ...swalOptions,
      title: 'ì„¤ì •ì„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
      html: `
        <p style="color: #64748b; font-size: 14px;">
          ë³€ê²½ëœ ì„¤ì •ì— ë§ì¶° ìƒˆë¡œìš´ í´ë”ê°€ ì¶”ê°€ë©ë‹ˆë‹¤.
        </p>
        <p style="color: #94a3b8; font-size: 12px; margin-top: 8px;">
          (ê¸°ì¡´ í´ë”ì™€ ì €ì¥ëœ ì˜ìƒì€ ìœ ì§€ë©ë‹ˆë‹¤)
        </p>
      `,
      icon: 'question',
      showCancelButton: true,
      confirmButtonColor: '#6366f1',
      cancelButtonColor: '#94a3b8',
      confirmButtonText: 'ì €ì¥',
      cancelButtonText: 'ì·¨ì†Œ'
    });

    if (!confirmResult.isConfirmed) return;

    setIsSubmitting(true);

    try {
      // 1. ì‚¬ìš©ì í”„ë¡œí•„ ì €ì¥
      const userData = {
        school_level: 'elementary',
        role,
        grade: role === 'homeroom' ? grade : null,
        target_grades: role === 'subject' ? targetGrades.sort((a, b) => a - b) : [grade],
        target_subjects: targetSubjects,
        folder_hierarchy: folderHierarchy,
        onboardingCompleted: true,
        updatedAt: Timestamp.now()
      };

      await setDoc(doc(db, 'users', user.uid), userData, { merge: true });

      // 2. í´ë” ì¶”ê°€ ìƒì„± (ê¸°ì¡´ í´ë”ëŠ” ìœ ì§€, ìƒˆë¡œìš´ í´ë”ë§Œ ì¶”ê°€)
      const grades = role === 'homeroom' ? [grade] : targetGrades;
      await generateUserFolders(user.uid, grades, targetSubjects, folderHierarchy);

      // 3. ì™„ë£Œ ì•Œë¦¼
      await Swal.fire({
        ...swalOptions,
        icon: 'success',
        title: 'ì„¤ì • ì €ì¥ ì™„ë£Œ! âœ¨',
        text: 'ìƒˆë¡œìš´ í´ë”ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.',
        confirmButtonColor: '#10b981',
        timer: 2000
      });

      onClose();
    } catch (error) {
      console.error('Settings save error:', error);
      Swal.fire({
        ...swalOptions,
        icon: 'error',
        title: 'ì˜¤ë¥˜ ë°œìƒ',
        text: 'ì„¤ì • ì €ì¥ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
        confirmButtonColor: '#ef4444'
      });
    } finally {
      setIsSubmitting(false);
    }
  };

  if (loading) {
    return (
      <div className="onboarding-overlay">
        <div className="onboarding-modal" style={{ maxWidth: '400px', textAlign: 'center', padding: '60px' }}>
          <div className="settings-loading">
            <div className="spinner"></div>
            <p>ì„¤ì • ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="onboarding-overlay" onClick={(e) => e.target === e.currentTarget && onClose()}>
      <div className="onboarding-modal settings-modal">
        {/* í—¤ë” */}
        <div className="settings-header">
          <div className="settings-header-content">
            <span className="settings-icon">âš™ï¸</span>
            <div>
              <h2>ë‚´ ì„¤ì •</h2>
              <p>ë‹´ë‹¹ í•™ë…„ê³¼ ê³¼ëª©ì„ ì„¤ì •í•˜ì„¸ìš”</p>
            </div>
          </div>
          <button className="settings-close-btn" onClick={onClose}>
            <IconX />
          </button>
        </div>

        {/* ì»¨í…ì¸  */}
        <div className="onboarding-content settings-content">
          {/* ì—­í•  ì„ íƒ */}
          <div className="settings-section">
            <label className="settings-label">ì—­í• </label>
            <div className="settings-role-toggle">
              <button
                className={`role-toggle-btn ${role === 'homeroom' ? 'active' : ''}`}
                onClick={() => handleRoleChange('homeroom')}
              >
                ğŸ‘©â€ğŸ« ë‹´ì„ êµì‚¬
              </button>
              <button
                className={`role-toggle-btn ${role === 'subject' ? 'active' : ''}`}
                onClick={() => handleRoleChange('subject')}
              >
                ğŸ“– êµê³¼ ì „ë‹´
              </button>
            </div>
          </div>

          {/* í•™ë…„ ì„ íƒ */}
          <div className="settings-section">
            <label className="settings-label">
              {role === 'homeroom' ? 'ë‹´ë‹¹ í•™ë…„' : 'ë‹´ë‹¹ í•™ë…„ (ë³µìˆ˜ ì„ íƒ)'}
            </label>
            <div className={`grade-grid ${role === 'homeroom' ? 'single' : ''}`}>
              {GRADES.map(g => (
                <button
                  key={g}
                  className={`grade-btn ${
                    role === 'homeroom' 
                      ? grade === g ? 'selected' : ''
                      : targetGrades.includes(g) ? 'selected' : ''
                  }`}
                  onClick={() => {
                    if (role === 'homeroom') {
                      setGrade(g);
                    } else {
                      toggleGrade(g);
                    }
                  }}
                >
                  {g}í•™ë…„
                  {role === 'subject' && targetGrades.includes(g) && (
                    <span className="check">âœ“</span>
                  )}
                </button>
              ))}
            </div>
          </div>

          {/* ê³¼ëª© ì„ íƒ */}
          <div className="settings-section">
            <div className="subject-header">
              <label className="settings-label">ë‹´ë‹¹ ê³¼ëª©</label>
              <button className="toggle-all-btn" onClick={toggleAllSubjects}>
                {targetSubjects.length === SUBJECTS.length ? 'ì „ì²´ í•´ì œ' : 'ì „ì²´ ì„ íƒ'}
              </button>
            </div>
            <div className="subject-grid">
              {SUBJECTS.map(subject => (
                <button
                  key={subject.id}
                  className={`subject-btn ${targetSubjects.includes(subject.id) ? 'selected' : ''}`}
                  style={{ '--subject-color': subject.color }}
                  onClick={() => toggleSubject(subject.id)}
                >
                  {subject.name}
                </button>
              ))}
            </div>
          </div>

          {/* í´ë” ê³„ì¸µ êµ¬ì¡° ì„ íƒ */}
          <div className="settings-section">
            <label className="settings-label">ğŸ“‚ í´ë” ê³„ì¸µ êµ¬ì¡°</label>
            <div className="hierarchy-options">
              {FOLDER_HIERARCHY_OPTIONS.map(option => (
                <button
                  key={option.id}
                  className={`hierarchy-option ${folderHierarchy === option.id ? 'selected' : ''}`}
                  onClick={() => setFolderHierarchy(option.id)}
                >
                  <div className="hierarchy-option-header">
                    <span className="hierarchy-icon">{option.icon}</span>
                    <span className="hierarchy-name">{option.name}</span>
                    {folderHierarchy === option.id && <span className="hierarchy-check">âœ“</span>}
                  </div>
                  <div className="hierarchy-example">{option.example}</div>
                </button>
              ))}
            </div>
          </div>

          {/* í˜„ì¬ ì„¤ì • ìš”ì•½ */}
          <div className="selection-summary">
            <h4>í˜„ì¬ ì„¤ì •</h4>
            <div className="summary-content">
              <div className="summary-item">
                <span className="label">ì—­í• :</span>
                <span className="value">{role === 'homeroom' ? 'ë‹´ì„ êµì‚¬' : 'êµê³¼ ì „ë‹´'}</span>
              </div>
              <div className="summary-item">
                <span className="label">í•™ë…„:</span>
                <span className="value">
                  {role === 'homeroom' 
                    ? (grade ? `${grade}í•™ë…„` : 'ë¯¸ì„ íƒ') 
                    : (targetGrades.length > 0 ? targetGrades.map(g => `${g}í•™ë…„`).join(', ') : 'ë¯¸ì„ íƒ')
                  }
                </span>
              </div>
              <div className="summary-item">
                <span className="label">ê³¼ëª©:</span>
                <span className="value" style={{ flex: 1 }}>
                  {targetSubjects.length > 0 
                    ? (targetSubjects.length === SUBJECTS.length 
                        ? 'ì „ ê³¼ëª©'
                        : targetSubjects.map(id => SUBJECTS.find(s => s.id === id)?.name).join(', ')
                      )
                    : 'ë¯¸ì„ íƒ'
                  }
                </span>
              </div>
            </div>
          </div>
        </div>

        {/* í‘¸í„° */}
        <div className="settings-footer">
          <button className="back-btn" onClick={onClose}>
            ì·¨ì†Œ
          </button>
          <button 
            className={`complete-btn ${!hasChanges() ? 'no-changes' : ''}`}
            onClick={handleSave}
            disabled={isSubmitting}
          >
            {isSubmitting ? 'ì €ì¥ ì¤‘...' : hasChanges() ? 'ğŸ’¾ ì„¤ì • ì €ì¥' : 'âœ“ ë³€ê²½ ì‚¬í•­ ì—†ìŒ'}
          </button>
        </div>
      </div>

      <style>{`
        /* Swalì´ ëª¨ë‹¬ ìœ„ì— ëœ¨ë„ë¡ z-index ì„¤ì • */
        .swal-above-modal {
          z-index: 10001 !important;
        }
        
        .settings-modal {
          max-width: 550px;
        }
        
        .settings-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 24px 30px;
          background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
          color: white;
        }
        
        .settings-header-content {
          display: flex;
          align-items: center;
          gap: 16px;
        }
        
        .settings-icon {
          font-size: 36px;
        }
        
        .settings-header h2 {
          font-size: 20px;
          font-weight: 600;
          margin: 0;
        }
        
        .settings-header p {
          font-size: 13px;
          opacity: 0.9;
          margin: 4px 0 0;
        }
        
        .settings-close-btn {
          background: rgba(255,255,255,0.2);
          border: none;
          border-radius: 8px;
          padding: 8px;
          cursor: pointer;
          color: white;
          transition: background 0.2s;
        }
        
        .settings-close-btn:hover {
          background: rgba(255,255,255,0.3);
        }
        
        .settings-content {
          padding: 24px 30px;
        }
        
        .settings-section {
          margin-bottom: 20px;
        }
        
        .settings-label {
          display: block;
          font-size: 13px;
          font-weight: 600;
          color: #475569;
          margin-bottom: 10px;
        }
        
        .settings-role-toggle {
          display: flex;
          gap: 10px;
        }
        
        .role-toggle-btn {
          flex: 1;
          padding: 12px 16px;
          background: white;
          border: 2px solid #e2e8f0;
          border-radius: 10px;
          font-size: 14px;
          font-weight: 500;
          color: #64748b;
          cursor: pointer;
          transition: all 0.15s;
        }
        
        .role-toggle-btn:hover {
          border-color: #8b5cf6;
          background: #faf5ff;
        }
        
        .role-toggle-btn.active {
          background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
          border-color: #8b5cf6;
          color: white;
        }
        
        .settings-footer {
          display: flex;
          justify-content: flex-end;
          gap: 12px;
          padding: 20px 30px;
          background: #f8fafc;
          border-top: 1px solid #e2e8f0;
        }
        
        .settings-loading {
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 16px;
          color: #64748b;
        }
        
        .spinner {
          width: 40px;
          height: 40px;
          border: 3px solid #e2e8f0;
          border-top-color: #6366f1;
          border-radius: 50%;
          animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
          to { transform: rotate(360deg); }
        }
        
        /* í´ë” ê³„ì¸µ êµ¬ì¡° ì„ íƒ */
        .hierarchy-options {
          display: flex;
          flex-direction: column;
          gap: 8px;
        }
        
        .hierarchy-option {
          display: flex;
          flex-direction: column;
          gap: 4px;
          padding: 12px 14px;
          background: white;
          border: 2px solid #e2e8f0;
          border-radius: 10px;
          text-align: left;
          cursor: pointer;
          transition: all 0.15s;
        }
        
        .hierarchy-option:hover {
          border-color: #8b5cf6;
          background: #faf5ff;
        }
        
        .hierarchy-option.selected {
          border-color: #8b5cf6;
          background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
        }
        
        .hierarchy-option-header {
          display: flex;
          align-items: center;
          gap: 8px;
        }
        
        .hierarchy-icon {
          font-size: 16px;
        }
        
        .hierarchy-name {
          font-size: 14px;
          font-weight: 600;
          color: #374151;
        }
        
        .hierarchy-check {
          margin-left: auto;
          color: #8b5cf6;
          font-weight: bold;
        }
        
        .hierarchy-example {
          font-size: 11px;
          color: #94a3b8;
          margin-left: 24px;
        }
        
        .hierarchy-option.selected .hierarchy-name {
          color: #7c3aed;
        }
        
        .hierarchy-option.selected .hierarchy-example {
          color: #a78bfa;
        }
        
        /* ë³€ê²½ ì‚¬í•­ ì—†ìŒ ìƒíƒœì˜ ë²„íŠ¼ */
        .complete-btn.no-changes {
          background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
          cursor: default;
        }
        
        .complete-btn.no-changes:hover {
          transform: none;
          box-shadow: none;
        }
      `}</style>
    </div>
  );
}









